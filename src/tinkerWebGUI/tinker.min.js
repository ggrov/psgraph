function zoomed(){graph.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function dragstarted(){d3.event.sourceEvent.stopPropagation()}function dragged(t){t.x=d3.event.x,t.y=d3.event.y,updateGraph(0)}function refineGraphData(t){function e(t){function e(t){if(r=t[0],t.length>1){r+=":";for(var e=1;e<t.length;e++)r+=" "+t[e]}return r}var r="";return t.forEach(function(t){r+=e(t)+", "}),r.slice(0,r.length-2)}nodes=[];for(var r in t.wire_vertices)nodes.push({id:r,type:"Boundary",label:"bound",w:10,h:10,x:parseInt(75*t.wire_vertices[r].annotation.coord[0]),y:-parseInt(75*t.wire_vertices[r].annotation.coord[1])});for(var r in t.node_vertices){var a=t.node_vertices[r].annotation?parseInt(75*t.node_vertices[r].annotation.coord[0]):0,n=t.node_vertices[r].annotation?-parseInt(75*t.node_vertices[r].annotation.coord[1]):0,s=10,c=10,i=t.node_vertices[r].data.type,d=null,o=null;switch(i){case"G":d=t.node_vertices[r].data.gn.name,o=t.node_vertices[r].data.gn.goal,dummyLabelText.text(d),s=dummyLabelText.node().getBBox().width+20;break;case"T_Identity":d="identity",s=30;break;case"T_Atomic":d=t.node_vertices[r].data.label?t.node_vertices[r].data.label:t.node_vertices[r].data.atm+"("+e(t.node_vertices[r].data.args)+")",dummyLabelText.text(d),s=dummyLabelText.node().getBBox().width+20,c=dummyLabelText.node().getBBox().height+10,o=t.node_vertices[r].data.atm;break;case"T_Graph":d=t.node_vertices[r].data.label?t.node_vertices[r].data.label:t.node_vertices[r].data.subgraph+"("+e(t.node_vertices[r].data.args)+")",dummyLabelText.text(d),s=dummyLabelText.node().getBBox().width+20,c=dummyLabelText.node().getBBox().height+10,o=t.node_vertices[r].data.subgraph;break;case"G_Break":d="STOP",dummyLabelBreakText.text(d),s=dummyLabelBreakText.node().getBBox().width+8}nodes.push({id:r,type:i,x:a,y:n,w:s,h:c,label:d,value:o})}edges=[];for(var r in t.dir_edges){var u,l;nodes.forEach(function(e){e.id==t.dir_edges[r].src&&(u=e),e.id==t.dir_edges[r].tgt&&(l=e)});var d=t.dir_edges[r].data.gtyp;dummyLabelEdgeText.text(d);var s=dummyLabelEdgeText.node().getBBox().width+4,c=dummyLabelEdgeText.node().getBBox().height+4;edges.push({id:r,label:d,src:u,tgt:l,w:s,h:c})}edges.contains=function(t,e){var r=!1;return edges.forEach(function(a){a.src.id==t&&a.tgt.id==e&&(r=!0)}),r}}function updateGraph(t){function e(t,e,r,a){for(var n=[],s=0;a>s;s++){var c=t[0]+Math.sin(2*Math.PI*s/a)*e,i=t[1]-Math.cos(2*Math.PI*s/a)*e,d=(c-t[0])*Math.cos(r)-(i-t[1])*Math.sin(r)+t[0],o=(i-t[1])*Math.cos(r)+(c-t[0])*Math.sin(r)+t[1];n.push([d,o])}return n}function r(t,e){function r(a,n){if(0!=n.length){var s=(-a[1]*(t[0][0]-e[n[0][2]][0])+a[0]*(t[0][1]-e[n[0][2]][1]))/(-n[0][0]*a[1]+a[0]*n[0][1]),c=(-n[0][1]*(t[0][0]-e[n[0][2]][0])+n[0][0]*(t[0][1]-e[n[0][2]][1]))/(-n[0][0]*a[1]+a[0]*n[0][1]);return s>=0&&1>=s&&c>=0&&1>=c?[t[0][0]+c*a[0],t[0][1]+c*a[1]]:r(a,n.slice(1))}return t[1]}for(var a=[t[1][0]-t[0][0],t[1][1]-t[0][1]],n=[],s=0;s<e.length;s++)n.push(s==e.length-1?[e[0][0]-e[s][0],e[0][1]-e[s][1],s,0]:[e[s+1][0]-e[s][0],e[s+1][1]-e[s][1],s,s+1]);return r(a,n)}t=void 0===typeof t?0:t;var a=graph.selectAll("g.edge").data(edges,function(t){return t.id+t.label+t.src.id+t.tgt.id});a.style("opacity",1);var n=a.enter().append("g").attr("class","edge").style("opacity",0);n.append("path").attr("class","edge").attr("marker-end","url(#end-arrow)"),n.append("rect").attr("class","labelEdge").attr("width",function(t){return t.w}).attr("height",function(t){return t.h}),n.append("text").attr("class","labelEdge").text(function(t){return t.label});var s=graph.selectAll("g.node").data(nodes,function(t){return t.id+t.type+t.label});s.style("opacity",1).transition().duration(t).attr("transform",function(t){return"translate("+t.x+","+t.y+")"});var c=s.enter().append("g").attr("class","node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).style("opacity",0).style("cursor","move").call(drag),i=c.filter(function(t){return"Boundary"==t.type});i.append("rect").attr("x",function(t){return-t.w/2}).attr("y",function(t){return-t.h/2}).attr("width",function(t){return t.w}).attr("height",function(t){return t.h}).style("opacity",0);var d=c.filter(function(t){return"T_Atomic"==t.type});d.append("rect").attr("class","atm").attr("x",function(t){return-t.w/2}).attr("y",function(t){return-t.h/2}).attr("width",function(t){return t.w}).attr("height",function(t){return t.h}),d.append("text").attr("class","label").text(function(t){return t.label}).attr("y",function(){return 5}),d.on("mouseover",tip.show).on("mouseout",tip.hide);var o=c.filter(function(t){return"T_Graph"==t.type});o.append("rect").attr("class","nst").attr("x",function(t){return-t.w/2+5}).attr("y",function(t){return-t.h/2+5}).attr("width",function(t){return t.w}).attr("height",function(t){return t.h}),o.append("rect").attr("class","nst").attr("x",function(t){return-t.w/2}).attr("y",function(t){return-t.h/2}).attr("width",function(t){return t.w}).attr("height",function(t){return t.h}),o.append("text").attr("class","label").text(function(t){return t.label}).attr("y",function(){return 5}),o.on("mouseover",tip.show).on("mouseout",tip.hide);var u=c.filter(function(t){return"G"==t.type});u.append("circle").attr("class","goal").attr("r",function(t){return t.w/2}),u.append("text").attr("class","label").text(function(t){return t.label}).attr("y",function(){return 5}),u.on("mouseover",tip.show).on("mouseout",tip.hide);var l=c.filter(function(t){return"T_Identity"==t.type});l.append("polygon").attr("class","id").attr("points",function(t){var r=e([0,0],t.w/2,0,3),a="";return r.forEach(function(t){a+=t[0]+","+t[1]+" "}),a});var p=c.filter(function(t){return"G_Break"==t.type});p.append("polygon").attr("class","break").attr("points",function(t){var r=e([0,0],t.w/2,.3927,8),a="";return r.forEach(function(t){a+=t[0]+","+t[1]+" "}),a}),p.append("text").attr("class","labelBreak").text(function(t){return t.label}).attr("y",function(){return 4}),c.transition().duration(t).style("opacity",1),s.exit().transition().duration(t).style("opacity",0).remove(),a.transition().duration(t).style("opacity",1),a.select("path.edge").transition().duration(t).attr("d",function(t){var a,n,s=t.src.x,c=t.src.y,i=t.tgt.x,d=t.tgt.y;if(t.src.id==t.tgt.id){switch(t.src.type){case"Boundary":case"T_Atomic":case"T_Graph":n=r([[s-50,c-50],[s,c]],[[s-t.src.w/2,c-t.src.h/2],[s+t.src.w/2,c-t.src.h/2],[s+t.src.w/2,c+t.src.h/2],[s-t.src.w/2,c+t.src.h/2]]),a=r([[s,c],[s+50,c-50]],[[s-t.src.w/2,c-t.src.h/2],[s+t.src.w/2,c-t.src.h/2],[s+t.src.w/2,c+t.src.h/2],[s-t.src.w/2,c+t.src.h/2]]);break;case"T_Identity":n=r([[s-50,c-50],[s,c]],e([s,c],t.src.w/2,0,3)),a=r([[s,c],[s+50,c-50]],e([s,c],t.src.w/2,0,3));break;case"G_Break":n=r([[s-50,c-50],[s,c]],e([s,c],t.src.w/2,.3927,8)),a=r([[s,c],[s+50,c-50]],e([s,c],t.src.w/2,.3927,8));break;case"G":n=r([[s-50,c-50],[s,c]],e([s,c],t.src.w/2,0,20)),a=r([[s,c],[s+50,c-50]],e([s,c],t.src.w/2,0,20));break;default:n=[s,c],a=[s,c]}return"M "+a[0]+" "+a[1]+" A 20 20 0 1 0 "+n[0]+" "+n[1]}switch(t.src.type){case"Boundary":case"T_Atomic":case"T_Graph":a=r([[i,d],[s,c]],[[s-t.src.w/2,c-t.src.h/2],[s+t.src.w/2,c-t.src.h/2],[s+t.src.w/2,c+t.src.h/2],[s-t.src.w/2,c+t.src.h/2]]);break;case"T_Identity":a=r([[i,d],[s,c]],e([s,c],t.src.w/2,0,3));break;case"G_Break":a=r([[i,d],[s,c]],e([s,c],t.src.w/2,.3927,8));break;case"G":a=r([[i,d],[s,c]],e([s,c],t.src.w/2,0,20));break;default:a=[s,c]}switch(t.tgt.type){case"Boundary":case"T_Atomic":case"T_Graph":n=r([[s,c],[i,d]],[[i-t.tgt.w/2,d-t.tgt.h/2],[i+t.tgt.w/2,d-t.tgt.h/2],[i+t.tgt.w/2,d+t.tgt.h/2],[i-t.tgt.w/2,d+t.tgt.h/2]]);break;case"T_Identity":n=r([[s,c],[i,d]],e([i,d],t.tgt.w/2,0,3));break;case"G_Break":n=r([[s,c],[i,d]],e([i,d],t.tgt.w/2,.3927,8));break;case"G":n=r([[s,c],[i,d]],e([i,d],t.tgt.w/2,0,20));break;default:n=[i,d]}if(edges.contains(t.tgt.id,t.src.id)){var o=Math.sqrt((a[0]-n[0])*(a[0]-n[0])+(a[1]-n[1])*(a[1]-n[1]));return"M "+a[0]+" "+a[1]+" A "+o+" "+o+" 0 0,1 "+n[0]+" "+n[1]}return"M "+a[0]+" "+a[1]+" L "+n[0]+" "+n[1]}),a.select("rect.labelEdge").transition().duration(t).attr("x",function(t){return t.src.id==t.tgt.id?t.src.x-t.w/2:edges.contains(t.tgt.id,t.src.id)?(t.src.x+t.tgt.x)/2-t.w/2-(t.src.y-t.tgt.y)/8:(t.src.x+t.tgt.x)/2-t.w/2}).attr("y",function(t){return t.src.id==t.tgt.id?t.src.y-45-t.h/2:edges.contains(t.tgt.id,t.src.id)?(t.src.y+t.tgt.y)/2-t.h/2+(t.src.x-t.tgt.x)/8:(t.src.y+t.tgt.y)/2-t.h/2}),a.select("text.labelEdge").transition().duration(t).attr("x",function(t){return t.src.id==t.tgt.id?t.src.x:edges.contains(t.tgt.id,t.src.id)?(t.src.x+t.tgt.x)/2-(t.src.y-t.tgt.y)/8:(t.src.x+t.tgt.x)/2}).attr("y",function(t){return t.src.id==t.tgt.id?t.src.y-42:edges.contains(t.tgt.id,t.src.id)?(t.src.y+t.tgt.y)/2+3+(t.src.x-t.tgt.x)/8:(t.src.y+t.tgt.y)/2+3}),a.exit().transition().duration(t).style("opacity",0).remove()}function loadNewGraph(t){t="undefined"==typeof t?{}:t,refineGraphData(t),updateGraph(500)}function updateGraphNav(){d3.select("button#previousSubGraph").attr("disabled",null),d3.select("button#nextSubGraph").attr("disabled",null),0>=currentIndex&&d3.select("button#previousSubGraph").attr("disabled",!0),currentIndex>=currentTactic.graphs.length-1&&d3.select("button#nextSubGraph").attr("disabled",!0),d3.select("span#graphIndices").text(currentIndex+1+" / "+currentTactic.graphs.length)}function changeTactic(t){psgraph.graphs.forEach(function(e){e.name==t&&(currentTactic=e)}),currentIndex=0,loadNewGraph(currentTactic.graphs[currentIndex]),updateGraphNav()}function previousSubGraph(){currentIndex>0&&(currentIndex-=1,loadNewGraph(currentTactic.graphs[currentIndex]),updateGraphNav())}function nextSubGraph(){currentIndex<currentTactic.graphs.length-1&&(currentIndex+=1,loadNewGraph(currentTactic.graphs[currentIndex]),updateGraphNav())}function loadPSGraph(t){psgraph=t;for(var e=psgraph.current.slice(0),r=e.reverse()[0],a=1;a<e.length;a++)r+=" > "+e[a];d3.select("span#graphTactic").text(r),tacticList=[],psgraph.graphs.forEach(function(t){tacticList.push(t.name),t.name==psgraph.current[0]&&(currentTactic=t)}),currentIndex=psgraph.current_index,loadNewGraph(currentTactic.graphs[currentIndex]),updateGraphNav();var n=d3.select("select#tacticList").selectAll("option").data(tacticList,function(t){return t});n.attr("selected",null),n.enter().append("option").attr("value",function(t){return t}).text(function(t){return t==psgraph.main?t+" - (root)":t}),n.attr("selected",function(t){return currentTactic.name==t?!0:null}),n.exit().remove(),d3.select("select#tacticList").on("change",function(){changeTactic(d3.event.target.value)})}function visualiseProof(t,e){currentPSGraphIndex="undefined"==typeof e?0:e,psgraphs=t,0==currentPSGraphIndex&&d3.select("button#previousPSGraph").attr("disabled",!0),currentPSGraphIndex==psgraphs.length-1&&d3.select("button#nextPSGraph").attr("disabled",!0),d3.select("span#vizIndices").text(currentPSGraphIndex+1+" / "+psgraphs.length),loadPSGraph(psgraphs[currentPSGraphIndex])}function previousPSGraph(){currentPSGraphIndex>0&&(d3.select("button#nextPSGraph").attr("disabled",null),currentPSGraphIndex-=1,0==currentPSGraphIndex&&d3.select("button#previousPSGraph").attr("disabled",!0),d3.select("span#vizIndices").text(currentPSGraphIndex+1+" / "+psgraphs.length),loadPSGraph(psgraphs[currentPSGraphIndex]))}function nextPSGraph(){currentPSGraphIndex<psgraphs.length-1&&(d3.select("button#previousPSGraph").attr("disabled",null),currentPSGraphIndex+=1,currentPSGraphIndex==psgraphs.length-1&&d3.select("button#nextPSGraph").attr("disabled",!0),d3.select("span#vizIndices").text(currentPSGraphIndex+1+" / "+psgraphs.length),loadPSGraph(psgraphs[currentPSGraphIndex]))}function dataLoaded(t,e){if(t){d3.select("div#content").style("display","none");var r=d3.select("div#error").style("visibility","visible");r.append("h2").text(t.status),r.append("h3").text(t.statusText)}else d3.select("div#error").style("display","none"),d3.select("div#content").style("visibility","visible"),d3.select("span#proofTitle").text(e.info.title),e.info.author&&d3.select("span#proofAuthor").text("by "+e.info.author),e.info.date&&d3.select("span#proofDate").text("("+e.info.date+")"),visualiseProof(e.psgraphs,grIndex)}var file=window.location.search?window.location.search.split("?")[1].split("/")[0]:"",grIndex=window.location.hash?parseInt(window.location.hash.split("#")[1].split("/")[0]):0,psgraphs,currentPSGraphIndex,psgraph,currentTactic,currentIndex,tacticList,width=d3.select("div#graph").node().getBoundingClientRect().width,height=d3.select("div#graph").node().getBoundingClientRect().height,nodes=[],edges=[],zoom=d3.behavior.zoom().scaleExtent([.2,5]).on("zoom",zoomed),drag=d3.behavior.drag().origin(function(t){return t}).on("dragstart",dragstarted).on("drag",dragged),tip=d3.tip().attr("class","tooltip").offset([-15,0]).html(function(t){switch(t.type){case"G":return"Goal "+t.label+" : "+t.value;case"T_Atomic":var e="";psgraph.atomic_tactics.forEach(function(r){r.name==t.value&&(e=r.tactic)});var r=""!=e?"Atomic tactic "+t.value+"<br>Definition : "+e:"Atomic tactic "+t.value;return r;case"T_Graph":var a="",n=0;psgraph.graphs.forEach(function(e){e.name==t.value&&(a=e.branch_type,n=e.graphs.length)});var r=""!=a?"Graph tactic "+t.value+"<br>Branch type : "+a+"<br>Number of subgraphs : "+n:"Graph tactic "+t.value;return r}}),svg=d3.select("div#graph").append("svg").attr("width","100%").attr("height","100%").append("g").attr("transform","translate("+width/2+","+height/2+")").call(zoom).call(tip),rect=svg.append("rect").attr("width","100%").attr("height","100%").style("fill","none").style("pointer-events","all").attr("transform","translate("+-width/2+","+-height/2+")"),graph=svg.append("g");svg.append("svg:defs").append("svg:marker").attr("id","end-arrow").attr("viewBox","0 -5 10 10").attr("refX",10).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("svg:path").attr("fill","#333").attr("d","M0,-5L10,0L0,5");var dummyLabelText=svg.append("text").attr("class","label").style("opacity",0),dummyLabelBreakText=svg.append("text").attr("class","labelBreak").style("opacity",0),dummyLabelEdgeText=svg.append("text").attr("class","labelEdge").style("opacity",0);""!=file?d3.json("records/"+file+".json",dataLoaded,function(t){window.alert("Request : "+t.responseURL+"\nStatus : "+t.status+"\nMessage : "+t.statusText),console.log(t)}):(d3.select("div#content").style("display","none"),d3.select("div#error").style("visibility","visible").append("h2").text("No file specified"));